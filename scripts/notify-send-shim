#!/bin/bash
# Wrapper that silently drops notify-send calls from Voxtype.
# All other callers pass through to the real notify-send.
# Implements proper option parsing to avoid matching message body text.

# Parse using index-based iteration so we can look ahead for option values.
# notify-send options that consume the next argument:
#   -u/--urgency, -t/--expire-time, -a/--app-name, -i/--icon,
#   -c/--category, -h/--hint
args=("$@")
i=0
while [ $i -lt ${#args[@]} ]; do
    arg="${args[$i]}"
    if [[ "$arg" == "--" ]]; then
        break  # End of options
    fi
    case "$arg" in
        --app-name=Voxtype|-aVoxtype)
            exit 0 ;;
        --app-name|-a)
            # Next arg is the value
            next="${args[$((i+1))]:-}"
            if [[ "$next" == "Voxtype" ]]; then
                exit 0
            fi
            i=$((i+2)); continue ;;
        --urgency=*|--expire-time=*|--icon=*|--category=*|--hint=*)
            ;;  # =VALUE options, consumed inline
        --urgency|--expire-time|--icon|--category|--hint|-u|-t|-i|-c|-h)
            i=$((i+2)); continue ;;  # Skip the value arg
        --transient|--wait|-e|-w|--version|--help)
            ;;  # No-value flags
        -*)
            ;;  # Unknown option, skip
        *)
            break ;;  # First positional arg â€” stop option parsing
    esac
    i=$((i+1))
done
# Find the real notify-send by excluding the shim directory from PATH.
# Prefer /usr/bin if it exists, then fall back to PATH search.
shim_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
real_notify=""
if [ -x /usr/bin/notify-send ]; then
    real_notify=/usr/bin/notify-send
else
    IFS=: read -ra dirs <<< "$PATH"
    for d in "${dirs[@]}"; do
        [ "$d" = "$shim_dir" ] && continue
        if [ -x "$d/notify-send" ]; then
            real_notify="$d/notify-send"
            break
        fi
    done
fi
if [ -n "$real_notify" ]; then
    exec "$real_notify" "$@"
fi
echo "notify-send-shim: could not find real notify-send in PATH" >&2
exit 127
