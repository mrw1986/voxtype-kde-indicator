#!/bin/bash
# Wrapper that silently drops notify-send calls from Voxtype.
# All other callers pass through to the real notify-send.
# Implements proper option parsing to avoid matching message body text.

# Parse using index-based iteration so we can look ahead for option values.
# notify-send options that consume the next argument:
#   -u/--urgency, -t/--expire-time, -a/--app-name, -i/--icon,
#   -c/--category, -h/--hint
args=("$@")
i=0
while [ $i -lt ${#args[@]} ]; do
    arg="${args[$i]}"
    if [[ "$arg" == "--" ]]; then
        break  # End of options
    fi
    case "$arg" in
        --app-name=Voxtype|-aVoxtype)
            exit 0 ;;
        --app-name|-a)
            # Next arg is the value
            next="${args[$((i+1))]:-}"
            if [[ "$next" == "Voxtype" ]]; then
                exit 0
            fi
            i=$((i+2)); continue ;;
        --urgency=*|--expire-time=*|--icon=*|--category=*|--hint=*)
            ;;  # =VALUE options, consumed inline
        --urgency|--expire-time|--icon|--category|--hint|-u|-t|-i|-c|-h)
            i=$((i+2)); continue ;;  # Skip the value arg
        --transient|--wait|-e|-w|--version|--help)
            ;;  # No-value flags
        -*)
            ;;  # Unknown option, skip
        *)
            break ;;  # First positional arg â€” stop option parsing
    esac
    i=$((i+1))
done
# Find the real notify-send by excluding the shim itself from results.
# Use realpath to prevent recursion from symlinks or path normalization.
shim_self="$(realpath -m "${BASH_SOURCE[0]}" 2>/dev/null || readlink -f "${BASH_SOURCE[0]}")"
real_notify=""
if [ -x /usr/bin/notify-send ]; then
    candidate_real="$(realpath -m /usr/bin/notify-send 2>/dev/null || readlink -f /usr/bin/notify-send)"
    [ "$candidate_real" != "$shim_self" ] && real_notify=/usr/bin/notify-send
fi
if [ -z "$real_notify" ]; then
    IFS=: read -ra dirs <<< "$PATH"
    for d in "${dirs[@]}"; do
        [ -x "$d/notify-send" ] || continue
        candidate_real="$(realpath -m "$d/notify-send" 2>/dev/null || readlink -f "$d/notify-send")"
        if [ "$candidate_real" != "$shim_self" ]; then
            real_notify="$d/notify-send"
            break
        fi
    done
fi
if [ -n "$real_notify" ]; then
    exec "$real_notify" "$@"
fi
echo "notify-send-shim: could not find real notify-send in PATH" >&2
exit 127
